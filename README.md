# SUAI Cloud App

## Структура репозитория

* `README.md` - файл, который вы сейчас читаете;
* `suaicloudapp` - веб-приложение;
* `config.toml` - файл конфигурации веб-приложения, написанный в нотации [TOML](https://ru.wikipedia.org/wiki/TOML).

## Конфигурация приложения

Для корректной работы приложения необходимо выполнить настройку [файла конфигурации](config.toml).

### Структура файла конфигурации
* `server` - параметры веб-серера
  * `host` - ip-адрес запуска сервера (`0.0.0.0` для того, чтобы сервер принимал запросы с любых адресов)
  * `port` - порт, на котором будет работать сервер (`8080` по умолчанию)
* `aws` - параметры окружения AWS
  * `region` - регион выполнения работы
* `s3` - параметры S3
  * `bucket` - имя S3 bucket
* `database` - параметры подключения к БД
  * `host` - адрес подключения
  * `port` - порт подключения
  * `user` - имя пользователя
  * `password` - пароль
  * `dbname` - имя базы данных
* `redis` - параметры Redis
  * `host` - адрес подключения
  * `port` - порт подключения
* `dynamodb` - параметры DynamoDB
  * `table` - имя таблицы DynamoDB
  * `partition_key` - имя ключа раздела таблицы DynamoDB

Пример конфигурации:

```toml
[server]
host = '0.0.0.0'
port = 8080

[aws]
region = 'eu-central-1'

[s3]
bucket = 'suaicloudbucket'

[database]
host = 'database-1.clhbct1n77at.eu-central-1.rds.amazonaws.com'
port = 3306
user = 'admin'
password = '12345678'
dbname = 'suai'

[redis]
host = 'r1.c9uznt.clustercfg.euc1.cache.amazonaws.com'
port = 6379

[dynamodb]
table = 'suaicloudtable'
partition_key = 'id'
```

Предполагается, что после внесения изменений данный файл конфигурации будет загружен в S3 bucket, с которого и будет автоматически скачан на ec2-инстанс.

## Развертывание приложения на облачной платформе AWS

#### S3 bucket

S3 bucket должен быть приватным и содержать в себе [само приложение](suaicloudapp) и настроенный [файл конфигурации](config.toml).

#### RDS

Приложение рассчитано на работу с СУБД `mysql` по шаблону `Free tier`. Также, нет необходимости в использовании шифорвания и создании бекапов. 

Для обеспечения безопасности доступа к базе данных, рекомендуется ограничить доступ, разрешив его только внутри VPC.

#### Redis

Кластер Redis должен быть развернут в приватных подсетях каждой охватываемой зоны доступности. Доступ к кластеру должен быть только внутри VPC.

#### DynamoDB

Таблица DynamoDB должна содержать в качестве `PrimaryKey` только `PartitionKey` (без `SortKey`). `PartitionKey` должен иметь тип `string`. Укажите имя вашей таблицы и ключа в конфигурационном файле приложения.

#### EC2 instance (Launch configuration/template)

Приложение подготовлено для запуска на `Amazon Linux 2` (но не ограничено им). Используется `Python 3.7`.  Можно воспользоваться заранее проверенным образом системы:

```
ami-047e03b8591f2d48a
```

Для запуска приложения необходимо подготовить [файл конфигурации](config.toml) в соответствии с примером, описанным выше.

После подготовки необходимо обеспечить возможность загрузки на каждый EC2 instance [самого приложение](suaicloudapp) и, собственно, [файла конфигурации](config.toml). Это может быть выполнено посредством размещения файлов в S3 bucket.

Доступ к S3 bucket и DynamoDB из EC2 инстанса может быть обеспечен прикрплением к EC2 инстансам заранее сконфигурированной IAM роли `ec2_iam_role`.

Для автоматического развертывания приложения лучше всего воспользоваться параметром `User data` в конфигурации запуска, указав скрипт, который будет выполнен автоматически при запуске машины.

Пример полного скрипта автоматического развертывания приложения (при условии, что само приложение и файл конфигурации размещены в S3 bucket) может выглядеть так:

```bash
#!/bin/bash
sudo mkdir /suaicloudapp
cd /suaicloudapp/
bucket=suaicloudbucket
sudo aws s3 sync s3://${bucket}/ .
sudo chmod +rwx suaicloudapp
./suaicloudapp
```

Обратите внимание, что для выполнения скрипта необходимо заменить `suaicloudbucket` на название вашего S3 bucket (т. е. задать переменной `bucket` другое значение):

```bash
bucket=suaicloudbucket
```

Для получения доступа к веб-интерфейсу приложения необходимо открыть порт, указанный в [файле конфигурации](config.toml).

Логгирование осуществляется в файл `output.log`, из которого можно будет получить информацию о работе приложения, ошибках и сообщениях вывода.

## Веб-интерфейс приложения

Получить доступ к веб-интерфейсу приложения можно перейдя по публичному адресу машины (или балансировщика) с указанием порта. Например: `52.59.111.129:8080`.

#### Database check

На странице `/database` можно выполнить проверку подключения к указанной в [файле конфигурации](config.toml) базе данных. Сообщение `OK` символизирует о корректном подключении.

#### Redis check

На странице `/redis` можно выполнить проверку подключения к указанному в [файле конфигурации](config.toml) кластеру Redis. Сообщение `OK` символизирует о корректном подключении.

#### S3 check

На странице `/s3` можно выполнить проверку доступа к S3 bucket, указанному в [файле конфигурации](config.toml). Сообщение `OK` символизирует о наличии доступа.

#### DynamoDB check

На странице `/dynamodb` можно выполнить проверку доступа к таблице DynamoDB, указанной в [файле конфигурации](config.toml). Сообщение `OK` символизирует о наличии доступа.

#### Health check

На странице `/health` можно выполнить проверку работоспособности веб-сервера. Сообщение `healthy` символизирует о корректности работы приложения. Эту страницу можно использовать для `health check` в группе масштабирования.

#### Logs

На странице `/logs` можно получить логи сервера. Логи могут быть полезными для определения проблем, возникших при работе приложения.
